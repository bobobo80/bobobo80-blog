Title: ä¸ªäººæœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²
Date: 2021-10-09
Category: Tech
Tags: docker, portainer, github actions

ä¹‹å‰è‡ªå·±åšäº†ä¸€ä¸ªå°é¡¹ç›®ï¼Œç”¨äºè®°å•è¯ã€‚å› ä¸ºç›®å‰çš„èƒŒå•è¯appä¸»è¦è¿˜æ˜¯è®°æ‹¼å†™ï¼Œè€Œæˆ‘æ¯”è¾ƒæ¬ ç¼ºçš„æ˜¯è®°è¯»éŸ³ï¼Œå¾ˆå¤šå•è¯çœ‹è§è®¤è¯†ï¼Œä½†æ˜¯å¬åˆ°è¯»éŸ³çš„ä¸çŸ¥é“æ˜¯å“ªä¸ªå•è¯ã€‚æ‰€ä»¥æƒ³ç€åšä¸ªç¨‹åºæ¥è®°è¯»éŸ³ï¼Œå¯ä»¥å…ˆå¬è¯»éŸ³å†é€‰æ˜¯å¦è®°ä½ã€‚

å¤§æ¦‚èƒŒæ™¯å°±æ˜¯è¿™æ ·ã€‚åšè¿™ä¸ªä¸»è¦ä¹Ÿæ˜¯ä¸ºäº†ä½“éªŒä¸€ä¸‹å®Œæ•´å‰ç«¯åç«¯å¼€å‘ï¼Œä»¥åŠéƒ¨ç½²çš„æ•´ä¸ªæµç¨‹ã€‚æ¯•ç«Ÿå·¥ä½œä¸­ä¸»è¦æ˜¯åç«¯ï¼Œè€Œä¸”å…¶å®åªåšåç«¯çš„ä¸€éƒ¨åˆ†ã€‚åšä¸ªå°é¡¹ç›®å¯ä»¥ä½“éªŒä¸€ä¸‹å…¨æµç¨‹ã€‚è¿™æ¬¡æˆ‘ç”¨äº†fastapiä½œä¸ºåç«¯ï¼Œäº†è§£ä¸€ä¸‹è¿™ä¸ªå¾ˆç«çš„æ–°æ¡†æ¶ï¼Œå‰ç«¯æš‚æ—¶æ˜¯vueï¼Œä¸è¿‡å‰ç«¯éƒ¨åˆ†ä¸ä¼šçš„å¤ªå¤šï¼Œç›®æ ‡å…ˆæ˜¯èƒ½ç”¨ã€‚

å¼€å‘çš„äº‹æš‚æ—¶æŒ‰ä¸‹ä¸è¡¨ï¼Œå…ˆæ¥è¯´è¯´æ˜¯å¦‚ä½•éƒ¨ç½²çš„ã€‚åœ¨ä»¥å‰æˆ‘ç©wordpressæ—¶ï¼Œè¿˜éƒ½æ˜¯ç”¨ä¸ªlnmpçš„è„šæœ¬ï¼Œç„¶åæŠŠphpç¨‹åºä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åå¯åŠ¨ã€‚ä¹‹ååœ¨äººäººè½¦ï¼Œä¹Ÿæ˜¯å·®ä¸å¤šï¼Œç”¨gitæ‹‰ä¸‹æ¥æ›´æ–°ï¼Œé‡å¯æœåŠ¡ï¼Œç”¨supervisorè‡ªåŠ¨é‡å¯æŒ‚æ‰çš„æœåŠ¡ã€‚è€Œåˆ°äº†å¤´æ¡ï¼Œä¸€ä¸‹å­å°±å…ˆè¿›äº†ï¼Œæœ‰TCEç³»ç»Ÿï¼Œç‚¹ä¸€ä¸‹å°±å‘å¸ƒæ–°é•œåƒéƒ¨ç½²äº†ã€‚ç°åœ¨shopeeçš„è¯ï¼Œä»‹äºä¸¤è€…ä¹‹é—´ï¼Œä¹Ÿç®—æ˜¯æœ‰è‡ªåŠ¨åŒ–çš„éƒ¨ç½²æµç¨‹ï¼Œåªä¸è¿‡ç³»ç»Ÿè¿˜æ²¡æ•´åˆåˆ°ä¸€èµ·ã€‚å¯¹æˆ‘è‡ªå·±æ¥è¯´ï¼Œè¿˜çœŸæ²¡æœ‰å®è·µè¿‡å®¹å™¨éƒ¨ç½²å’Œè¿ç»´ï¼Œæ‰€ä»¥ä¹Ÿå€Ÿè¿™ä¸ªé¡¹ç›®å®è·µä¸€ä¸‹ã€‚

æˆ‘åªä¹°äº†ä¸€å°ä¸ä¸­ä¸çº§åˆ«çš„vpsï¼Œbuyvmçš„512mbã€‚ä¸€å¹´åªè¦20åˆ€ã€‚ä¸è¿‡æ²¡æœ‰æ–°åŠ å¡èŠ‚ç‚¹ï¼Œå»¶æ—¶å¤§ä¸€äº›ã€‚k8s/k3sæš‚æ—¶å…ˆä¸ä½“éªŒäº†ï¼Œä¸æƒ³ä¸€æ­¥è¿ˆçš„å¤ªå¤§ï¼Œé…ç½®ä¹Ÿä¸å¤Ÿï¼Œå’‹çœ‹èµ·æ¥å¤æ‚åº¦ä¹Ÿå¾ˆé«˜ã€‚

æˆ‘ä¸»è¦å‚è€ƒçš„æ˜¯[è¿™ä¸ªæ–‡ç« ](https://www.kilerd.me/personal-docker-cluster-and-ci-package-pipeline/)ï¼Œç”¨çš„docker swarmåŠ ä¸Športainerä½œä¸ºuiæ¥ç®¡ç†ï¼Œåªä¸è¿‡æˆ‘ç”¨äº†å›¾å½¢åŒ–nginxç®¡ç†å·¥å…·ã€‚è¿™ä¸ªé¡¹ç›®æ¯”è¾ƒç®€å•ï¼Œæ•°æ®åº“ç”¨çš„postgresql(ä¹Ÿæ˜¯æˆ‘ä¸ç†Ÿæ‚‰çš„ï¼Œpgadminä¸å¥½ç”¨å•ŠğŸ¤£ï¼‰ï¼Œä¼šæœ‰ä¸€ä¸ªcontianerï¼Œç„¶åpythonåç«¯èµ·ä¸€ä¸ªå®¹å™¨ã€‚å‰ç«¯æ˜¯ä¸€ä¸ªnginxçš„å®¹å™¨ã€‚æˆ‘ç”¨åˆ°äº†[nginx proxy manager](https://nginxproxymanager.com/)æ¥ç®¡ç†http/sï¼Œè¿™ä¸ªå·¥å…·å¯ä»¥è®¾ç½®è‡ªåŠ¨æ›´æ–°sslè¯ä¹¦ï¼Œå¦å¤–æœ‰uiç•Œé¢ï¼Œå°†subdomainåˆ†ç»™portainerï¼Œå‰ç«¯ï¼Œåç«¯ã€‚è¿™éƒ¨åˆ†å¯ä»¥ç”¨traefikåšï¼Œä¸è¿‡æˆ‘è¿˜æ²¡æœ‰ç ”ç©¶æ€ä¹ˆå†™é…ç½®ã€‚

NPMé…ç½®
```dockerfile
version: "3"

networks:
  nginx-net:
    external: true

volumes:
  nginx-data:
    external:
      name: nginx-data
  letsencrypt:
    external:
      name: letsencrypt

services:
  app:
    image: 'jc21/nginx-proxy-manager:latest'
    ports:
      # HTTP port
      - '80:80'
      # HTTPS Port:
      - '443:443'
      # Admin UI
      # - '81:81'
    environment:
      DB_SQLITE_FILE: "/data/npm.sqlite"
    volumes:
      - nginx-data:/data
      - letsencrypt:/etc/letsencrypt
    networks:
      - nginx-net
```
npmæ²¡æœ‰ä½¿ç”¨å®˜æ–¹çš„mysqlé…ç½®ï¼Œç”¨äº†sqliteæ•°æ®åº“ï¼Œå¦å¤–è®¾ç½®äº†ä¸¤ä¸ªvolumesï¼Œç”¨äºå­˜é…ç½®å’Œè¯ä¹¦ã€‚åœ¨httpsè½¬å‘æ²¡é…ç½®å¥½ä¹‹å‰ï¼Œ81ç«¯å£æ˜¯å¯¹å¤–å¼€å‘çš„ï¼Œåœ¨é…ç½®å¥½åï¼Œæ³¨é‡Šæ‰ï¼Œåªä¿ç•™80å’Œ443

æœ‰äº†è¿™äº›ï¼Œåªæ˜¯èƒ½è®©æœåŠ¡è·‘èµ·æ¥ï¼Œè¿˜æ²¡æœ‰è¾¾åˆ°å­¦ä¹ ç›®çš„ã€‚ä¸ºäº†è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œè¿˜æœ‰äº›é¢å¤–çš„å·¥ä½œã€‚é¦–å…ˆæ˜¯é•œåƒä»“åº“ï¼Œé‰´äºdocker/githubçš„ç§æœ‰é•œåƒåº“å…è´¹é¢åº¦ä¸å¤ªå¤Ÿï¼Œæ‰€ä»¥æˆ‘å’Œé‚£ä¸ªæ•™ç¨‹ä»‹ç»çš„ä¸€æ ·ï¼Œéƒ¨ç½²äº†è‡ªå·±çš„registryã€‚å’Œæ•™ç¨‹ä¸ä¸€æ ·çš„ï¼Œæˆ‘ç”¨äº†github actionï¼Œç”¨github actionæ¥è§¦å‘å·¥ä½œæµï¼Œå½“åœ¨githubé‡Œå‘å¸ƒä¹‹åï¼Œä¼šè§¦å‘å·¥ä½œæµæ‰“åŒ…é•œåƒï¼Œç„¶åæ¨åˆ°è‡ªå·±çš„registryï¼Œç„¶åè§¦å‘portainerçš„webhookï¼Œæ›´æ–°docker serviceã€‚è¿™é‡Œæ³¨æ„æˆ‘åœ¨ç”Ÿæˆregistryçš„å¯†ç æ—¶ï¼Œç”¨çš„å‚è€ƒæ–‡ç« çš„å‘½ä»¤æœ‰é—®é¢˜ï¼ŒåˆæŸ¥äº†ä¸‹[dockerçš„æ–‡æ¡£](https://docs.docker.com/registry/deploying/#native-basic-auth)ã€‚
```bash
docker run --entrypoint htpasswd httpd:2 -Bbn testuser testpassword > auth/htpasswd
```

github actions
```yaml
name: Build and Publish Docker image
on: 
  release:
    types: [published]
jobs:
  push_to_registries:
    name: Build and Push Docker image to multiple registries
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - id: get_version
        uses: battila7/get-version-action@v2
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build BE image
        uses: docker/build-push-action@v2
        with:
          push: true
          context: server
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/xxx-be:latest
            ${{ secrets.DOCKER_REGISTRY }}/xxx-be:${{ steps.get_version.outputs.version-without-v }}
      - name: Invoke BE deploy webhook
        uses: joelwmale/webhook-action@master
        with:
          url: ${{ secrets.BE_WEBHOOK_URL }}
      - name: Build FE image
        uses: docker/build-push-action@v2
        with:
          push: true
          context: web_fe
          build-args: VUE_APP_BASE_URL=${{ secrets.VUE_APP_BASE_URL }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/xxx-fe:latest
            ${{ secrets.DOCKER_REGISTRY }}/xxx-fe:${{ steps.get_version.outputs.version-without-v }}
      - name: Invoke FE deploy webhook
        uses: joelwmale/webhook-action@master
        with:
          url: ${{ secrets.FE_WEBHOOK_URL }}

```
github actionsè¿™é‡Œæ˜¯å‰ç«¯åç«¯åŒæ—¶éƒ¨ç½²ï¼Œå¯ä»¥åˆ†å¼€ä¸¤ä¸ªactionã€‚æˆ‘ç”¨åˆ°äº†å–release versionçš„ï¼Œè¿™æ ·åœ¨pushåˆ°registryæ—¶å¯ä»¥é™„å¸¦ä¸Šversionï¼Œæˆ‘ä»¬å°±å¯ä»¥å›æ»šæœåŠ¡äº†ã€‚æˆ‘è¿™é‡Œè§¦å‘æ¡ä»¶æ˜¯releaseï¼Œæ‰€ä»¥åœ¨mergeåˆ°main(æ˜¯çš„ï¼Œç°åœ¨é»˜è®¤å˜æˆmainåˆ†æ”¯äº†)æ—¶å¹¶ä¸è§¦å‘éƒ¨ç½²ï¼Œåªæœ‰åœ¨releaseé¡µé¢æ‰“tagåæ‰ä¼šã€‚

æœ‰å‡ ä¸ªå‘
- ä¸ºäº†å®‰å…¨ï¼Œä¼šæŠŠportainerçš„webç«¯å£ä¸æš´éœ²åœ¨å¤–ï¼Œç”±nginxè½¬å‘ï¼Œæ‰€ä»¥åœ¨è°ƒæ•´nginxå®¹å™¨æ—¶ä¸€æ—¦æŒ‚äº†ï¼Œportainer uiä¹Ÿä¼šæŒ‚æ‰ã€‚æ‰€ä»¥ä¸€èˆ¬å¯ä»¥å…ˆæŠŠ9001 uiç«¯å£å¯¹å¤–æ‰“å¼€ï¼Œè®¾ç½®å¥½nginxä¹‹åï¼Œå†æ›´æ–°portainerçš„è®¾ç½®ã€‚
- åŒç†ï¼Œnginx proxy manager ä¹Ÿæœ‰ä¸ª81ç«¯å£ï¼Œåœ¨é…ç½®å¥½httpsè½¬å‘ä¹‹åï¼Œåº”è¯¥æ›´æ–°dockeré…ç½®ï¼Œä¸è¦è®©81ç«¯å£å¯¹å¤–ã€‚
- å¦‚æœæœ‰å¤šå°æœºå™¨ç»„ç½‘ï¼Œå¯¹äºportainerå’Œdbï¼Œåº”è¯¥ä½¿ç”¨é…ç½®å›ºå®šåˆ°ä¸€å°å®ä½“æœºä¸Š[docker-swarm deploy placement constraints](https://docs.docker.com/engine/swarm/services/#control-service-placement)ï¼Œå› ä¸ºvolumeåªåœ¨ä¸€å°ä¸Šï¼Œå®é™…ä¸Šæœ‰å®¹å™¨éƒ¨ç½²dbä¹Ÿä¸ç®—æ˜¯å¥½çš„å®è·µå•¦ã€‚
- é•œåƒå¦‚æœæœ‰ç‰ˆæœ¬tagï¼Œregistryä¼šè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœç©ºé—´å°çš„è¯ï¼Œè¦æ³¨æ„æ¸…ç†ï¼Œå‰ç«¯çš„é•œåƒåº”è¯¥æ¯”è¾ƒå°ï¼Œæˆ‘çš„pythonçš„é•œåƒå¥½åƒæ˜¯150å¤šmbã€‚å¯¹äºæ€»å…±10gçš„vpsæ¥è¯´ï¼Œè¿˜æŒºå åœ°æ–¹çš„ã€‚
- åœ¨portaineræ–°å»ºnetworkæ—¶ï¼Œä¸»è¦åŠ ä¸Šattachableï¼Œä¸ç„¶å…¶ä»–å®¹å™¨åæœŸæ— æ³•åŠ å…¥ç½‘ç»œã€‚